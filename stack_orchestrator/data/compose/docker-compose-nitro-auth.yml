version: '3.7'

services:
  go-nitro-alice:
    image: cerc/go-nitro:local
    hostname: go-nitro-alice
    restart: on-failure
    depends_on:
      - go-nitro-bootnode
    environment:
      CERC_NITRO_CHAIN_PK: ${CERC_NITRO_CHAIN_PK_ALICE:-888814df89c4358d7ddb3fa4b0213e7331239a80e1f013eaa7b2deca2a41a218}
      CERC_NITRO_CHAIN_URL: ${CERC_NITRO_CHAIN_URL:-ws://fixturenet-eth-geth-1:8546}
      CERC_NA_ADDRESS: ${CERC_NA_ADDRESS}
      CERC_VPA_ADDRESS: ${CERC_VPA_ADDRESS}
      CERC_CA_ADDRESS: ${CERC_CA_ADDRESS}
    env_file:
      - ../config/nitro-auth/alice.env
    entrypoint: ["bash", "-c", "/app/run-nitro-node.sh"]
    volumes:
      - nitro_deployment:/app/deployment
      - go_nitro_data_alice:/app/data
      - ../config/go-nitro/run-nitro-node.sh:/app/run-nitro-node.sh
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "4006"]
      interval: 5s
      timeout: 5s
      retries: 100
      start_period: 100s
    ports:
      - "3006"
      - "4006"
      - "5006"
      - "4106"
      - "4206"
      - "4216"

  go-nitro-bob:
    image: cerc/go-nitro:local
    hostname: go-nitro-bob
    restart: on-failure
    depends_on:
      - go-nitro-bootnode
    environment:
      CERC_NITRO_CHAIN_PK: ${CERC_NITRO_CHAIN_PK_BOB:-570b909da9669b2f35a0b1ac70b8358516d55ae1b5b3710e95e9a94395090597}
      CERC_NITRO_CHAIN_URL: ${CERC_NITRO_CHAIN_URL:-ws://fixturenet-eth-geth-1:8546}
      CERC_NA_ADDRESS: ${CERC_NA_ADDRESS}
      CERC_VPA_ADDRESS: ${CERC_VPA_ADDRESS}
      CERC_CA_ADDRESS: ${CERC_CA_ADDRESS}
    env_file:
      - ../config/nitro-auth/bob.env
    entrypoint: ["bash", "-c", "/app/run-nitro-node.sh"]
    volumes:
      - nitro_deployment:/app/deployment
      - go_nitro_data_bob:/app/data
      - ../config/go-nitro/run-nitro-node.sh:/app/run-nitro-node.sh
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "4007"]
      interval: 5s
      timeout: 5s
      retries: 100
      start_period: 100s
    ports:
      - "3007"
      - "4007"
      - "5007"
      - "4107"
      - "4207"
      - "4217"

  ts-nitro-charlie:
    image: cerc/ts-nitro:local
    hostname: ts-nitro-charlie
    restart: on-failure
    depends_on:
      - go-nitro-bootnode
    environment:
      CERC_NITRO_CHAIN_PK: ${CERC_NITRO_CHAIN_PK_CHARLIE:-111b7500bdce494d6f4bcfe8c2a0dde2ef92f751d9070fac6475dbd6d8021b3f}
      CERC_NITRO_CHAIN_URL: ${CERC_NITRO_CHAIN_URL:-ws://fixturenet-eth-geth-1:8546}
      CERC_NA_ADDRESS: ${CERC_NA_ADDRESS}
      CERC_VPA_ADDRESS: ${CERC_VPA_ADDRESS}
      CERC_CA_ADDRESS: ${CERC_CA_ADDRESS}
      CERC_NITRO_TARGET_URL: ${CERC_NITRO_TARGET_URL:-http://localhost:5678}
      CERC_RUNTIME_ENV_RPC_URL: ${CERC_RUNTIME_ENV_RPC_URL:-ws://localhost:8546}
      PUBLIC_URL: http://localhost:5678/ts-nitro
    env_file:
      - ../config/nitro-auth/charlie.env
    entrypoint: ["bash", "-c", "/app/run.sh"]
    volumes:
      - nitro_deployment:/app/deployment
      - ../config/ts-nitro/run.sh:/app/run.sh
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "3000"]
      interval: 5s
      timeout: 5s
      retries: 100
      start_period: 100s

  go-nitro-bootnode:
    image: cerc/go-nitro:local
    hostname: go-nitro-bootnode
    restart: on-failure
    environment:
      CERC_NITRO_CHAIN_URL: ${CERC_NITRO_CHAIN_URL:-ws://fixturenet-eth-geth-1:8546}
      CERC_NA_ADDRESS: ${CERC_NA_ADDRESS}
      CERC_VPA_ADDRESS: ${CERC_VPA_ADDRESS}
      CERC_CA_ADDRESS: ${CERC_CA_ADDRESS}
      CERC_NITRO_RELAY_ON: true
    env_file:
      - ../config/nitro-auth/bootnode.env
    entrypoint: [ "bash", "-c", "/app/run-nitro-node.sh" ]
    volumes:
      - nitro_deployment:/app/deployment
      - go_nitro_data_bootnode:/app/data
      - ../config/go-nitro/run-nitro-node.sh:/app/run-nitro-node.sh
    healthcheck:
      test: [ "CMD", "nc", "-vz", "localhost", "4008" ]
      interval: 5s
      timeout: 5s
      retries: 100
      start_period: 100s
    ports:
      - "9090"

  nitro-caddy:
    image: caddy:2-alpine
    restart: always
    environment:
      CERC_ETH_RPC_ENDPOINT: ${CERC_ETH_RPC_ENDPOINT:-http://fixturenet-eth-geth-1:8545}
    volumes:
      - ../config/nitro-auth/caddy/Caddyfile:/etc/caddy/Caddyfile
    ports:
      - "5678"
    depends_on:
      - go-nitro-alice
      - go-nitro-bob

volumes:
  go_nitro_data_alice:
  go_nitro_data_bob:
  go_nitro_data_bootnode:
  nitro_deployment:
